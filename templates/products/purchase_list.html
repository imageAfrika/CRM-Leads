{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/products/list.css' %}">
<link rel="stylesheet" href="{% static 'css/products/purchase_list.css' %}">
{% endblock %}

{% block content %}
<div class="list-container">
    <div class="list-header">
        <h1><i class="fas fa-shopping-cart"></i> Purchase Orders</h1>
        <div class="list-actions">
            <a href="{% url 'products:purchase_create' %}" class="action-button">
                <i class="fas fa-plus"></i> New Purchase Order
            </a>
        </div>
    </div>

    <div class="filters-bar">
        <div class="filter-group type-filter">
            <label class="filter-label" for="status">Status</label>
            <select id="status" name="status" class="filter-input">
                <option value="">All Statuses</option>
                <option value="DRAFT">Draft</option>
                <option value="PENDING">Pending</option>
                <option value="APPROVED">Approved</option>
                <option value="RECEIVED">Received</option>
                <option value="CANCELED">Canceled</option>
            </select>
        </div>
        <div class="filter-group search-filter">
            <label class="filter-label" for="search">Search</label>
            <input type="text" id="search" name="search" class="filter-input" placeholder="Search by ref, supplier...">
        </div>
        <div class="filter-group date-filter">
            <label class="filter-label" for="date">Date</label>
            <input type="date" id="date" name="date" class="filter-input">
        </div>
    </div>

    <div class="purchase-list">
        {% for purchase in purchases %}
        <div class="purchase-item">
            <div class="purchase-header">
                <div class="purchase-main">
                    <div class="purchase-ref">
                        <a href="{% url 'products:purchase_detail' purchase.id %}">{{ purchase.reference_number }}</a>
                    </div>
                    <div class="purchase-status status-{{ purchase.status|lower }}">
                        {{ purchase.get_status_display }}
                    </div>
                </div>
                <div class="purchase-date">
                    <i class="fas fa-calendar"></i> {{ purchase.purchase_date|date:"d M Y" }}
                </div>
            </div>
            <div class="purchase-body">
                <div class="purchase-supplier">
                    <i class="fas fa-truck"></i>
                    {{ purchase.supplier.name }}
                </div>
                <div class="purchase-totals">
                    <div class="purchase-items">
                        <i class="fas fa-boxes"></i>
                        {{ purchase.items.count }} Items
                    </div>
                    <div class="purchase-amount">
                        <i class="fas fa-dollar-sign"></i>
                        ${{ purchase.total_amount|floatformat:2 }}
                    </div>
                </div>
            </div>
            <div class="purchase-actions">
                <a href="{% url 'products:purchase_detail' purchase.id %}" class="btn-icon" title="View">
                    <i class="fas fa-eye"></i>
                </a>
                {% if purchase.status == 'DRAFT' or purchase.status == 'PENDING' %}
                <a href="{% url 'products:purchase_update' purchase.id %}" class="btn-icon" title="Edit">
                    <i class="fas fa-edit"></i>
                </a>
                {% endif %}
                {% if purchase.status == 'DRAFT' %}
                <a href="#" class="btn-icon delete-item" data-id="{{ purchase.id }}" data-type="purchase" title="Delete">
                    <i class="fas fa-trash"></i>
                </a>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="no-items">
            <i class="fas fa-shopping-cart"></i>
            <p>No purchase orders found</p>
            <a href="{% url 'products:purchase_create' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Create First Purchase Order
            </a>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal" id="deleteModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Confirm Delete</h3>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to delete this purchase order? This action cannot be undone.</p>
            <p class="warning">Note: This will only delete draft purchase orders.</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="cancelDelete">Cancel</button>
            <form method="post" id="deleteForm" action="">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger">Delete</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/products/list.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set up delete confirmation
    setupDeleteConfirmation('products:purchase_delete');
    
    // Setup filters
    const statusSelect = document.getElementById('status');
    const searchInput = document.getElementById('search');
    const dateInput = document.getElementById('date');

    function updateFilters() {
        const params = new URLSearchParams(window.location.search);
        if (statusSelect.value) params.set('status', statusSelect.value);
        if (searchInput.value) params.set('search', searchInput.value);
        if (dateInput.value) params.set('date', dateInput.value);
        window.location.href = `${window.location.pathname}?${params.toString()}`;
    }

    statusSelect.addEventListener('change', updateFilters);
    searchInput.addEventListener('input', debounce(updateFilters, 500));
    dateInput.addEventListener('change', updateFilters);

    // Initialize filter values from URL params
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('status')) statusSelect.value = urlParams.get('status');
    if (urlParams.has('search')) searchInput.value = urlParams.get('search');
    if (urlParams.has('date')) dateInput.value = urlParams.get('date');
    
    function debounce(func, wait) {
        let timeout;
        return function() {
            const context = this, args = arguments;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
        };
    }
});
</script>
{% endblock %} 